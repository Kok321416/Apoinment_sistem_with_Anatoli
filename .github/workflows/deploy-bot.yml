# GitHub Actions workflow для автоматического деплоя Telegram бота
# Используйте этот файл, если используете GitHub Actions

name: Deploy Telegram Bot

# Деплой бота только при push в main (после мержа) или вручную. develop убран — иначе при каждом PR 2 экшена
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check required secrets
      run: |
        # Поддерживаем оба набора: DEPLOY_* и VPS_* (одинаковые значения)
        HOST="${{ secrets.DEPLOY_HOST || secrets.VPS_HOST }}"
        USER="${{ secrets.DEPLOY_USER || secrets.VPS_USER }}"
        KEY="${{ secrets.DEPLOY_SSH_KEY || secrets.VPS_SSH_KEY }}"
        PATH_SECRET="${{ secrets.DEPLOY_PATH || secrets.APP_DIR }}"
        MISSING=""
        [ -z "$HOST" ] && MISSING="${MISSING}DEPLOY_HOST or VPS_HOST "
        [ -z "$USER" ] && MISSING="${MISSING}DEPLOY_USER or VPS_USER "
        [ -z "$KEY" ] && MISSING="${MISSING}DEPLOY_SSH_KEY or VPS_SSH_KEY "
        [ -z "$PATH_SECRET" ] && MISSING="${MISSING}DEPLOY_PATH or APP_DIR "
        if [ -n "$MISSING" ]; then
          echo "::error::Missing GitHub Actions secrets: $MISSING"
          echo "Add them in: Repository → Settings → Secrets and variables → Actions"
          echo "Use either DEPLOY_HOST/DEPLOY_USER/... or VPS_HOST/VPS_USER/VPS_SSH_KEY/APP_DIR"
          exit 1
        fi
        echo "Required bot deploy secrets are set (host length: ${#HOST})"

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST || secrets.VPS_HOST }}
        username: ${{ secrets.DEPLOY_USER || secrets.VPS_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY || secrets.VPS_SSH_KEY }}
        envs: TELEGRAM_BOT_TOKEN,SITE_URL
        script: |
          set -e
          APP_DIR="${{ secrets.DEPLOY_PATH || secrets.APP_DIR }}"
          APP_DIR=$(printf '%s' "$APP_DIR" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ ! -d "$APP_DIR" ]; then
            echo "::error::Directory from APP_DIR/DEPLOY_PATH does not exist on server. SSH to the server, go to your project folder, run 'pwd', and set that path in GitHub Secrets → APP_DIR (or DEPLOY_PATH). Run main workflow 'Deploy to VPS' first to create the directory."
            exit 1
          fi
          cd "$APP_DIR"

          # На reg.ru нет sudo и нет доступа к systemd — не используем sudo
          # Код на сервер попадает через основной workflow (deploy.yml, SCP), git pull на shared-хостинге часто без учётки
          git pull origin main || true

          export PATH="$HOME/.local/bin:$HOME/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
          [ -d venv ] && . venv/bin/activate || true
          pip install -q -r requirements.txt

          # .env создаётся основным деплоем (deploy.yml); бот использует те же DB_* и TELEGRAM_BOT_TOKEN из env
          if [ -f "$APP_DIR/.env" ]; then
            set -a
            . "$APP_DIR/.env"
            set +a
          fi
          export TELEGRAM_BOT_TOKEN
          export SITE_URL

          python manage.py migrate --noinput 2>/dev/null || true
          python manage.py collectstatic --noinput 2>/dev/null || true

          BOT_PIDFILE="$APP_DIR/bot.pid"
          BOT_LOG="$APP_DIR/bot.log"
          if [ -f "$BOT_PIDFILE" ]; then
            OLD_PID=$(cat "$BOT_PIDFILE")
            kill -TERM "$OLD_PID" 2>/dev/null || true
            rm -f "$BOT_PIDFILE"
            sleep 2
          fi
          nohup python manage.py run_bot >> "$BOT_LOG" 2>&1 &
          BOT_PID=$!
          echo $BOT_PID > "$BOT_PIDFILE"
          sleep 3
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "Bot started, PID $BOT_PID"
          else
            echo "::error::Bot process exited. Last 30 lines of bot.log:"
            tail -30 "$BOT_LOG" 2>/dev/null || true
            exit 1
          fi

