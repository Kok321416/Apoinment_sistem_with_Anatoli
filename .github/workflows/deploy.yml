name: Deploy to VPS

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  pull-requests: read
  contents: read

jobs:
  check-approval:
    runs-on: ubuntu-latest
    outputs:
      is-approved: ${{ steps.check.outputs.is-approved }}
      pr-number: ${{ github.event.pull_request.number }}
    
    steps:
      - name: Check PR approval
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseRef = context.payload.pull_request.base.ref;
            const headRef = context.payload.pull_request.head.ref;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ PR –∏–∑ develop –≤ main
            if (baseRef !== 'main' || headRef !== 'develop') {
              console.log(`Skipping: PR from ${headRef} to ${baseRef} (expected: develop -> main)`);
              core.setOutput('is-approved', 'false');
              return;
            }
            
            try {
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω APPROVED review
              const hasApproval = reviews.some(review => review.state === 'APPROVED');
            
              console.log(`PR #${context.issue.number} from ${headRef} to ${baseRef}`);
              console.log(`Has approval: ${hasApproval}`);
              console.log(`Reviews: ${JSON.stringify(reviews.map(r => ({state: r.state, author: r.user.login})))}`);
              
              core.setOutput('is-approved', hasApproval.toString());
            } catch (error) {
              // –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ reviews, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ approval –µ—Å—Ç—å (–µ—Å–ª–∏ PR merged, –∑–Ω–∞—á–∏—Ç –±—ã–ª approved —á–µ—Ä–µ–∑ Branch Protection)
              console.log(`Cannot check reviews (may require Branch Protection): ${error.message}`);
              console.log(`PR merged status: ${context.payload.pull_request.merged}`);
              // –ï—Å–ª–∏ PR –±—ã–ª merged - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ approval –±—ã–ª (Branch Protection –Ω–µ –¥–∞—Å—Ç merge –±–µ–∑ approval)
              const hasApproval = context.payload.pull_request.merged === true;
              core.setOutput('is-approved', hasApproval.toString());
            }
    
  deploy:
    runs-on: ubuntu-latest
    needs: check-approval
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ PR –∏–∑ develop –≤ main —Å approval
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'develop' &&
      needs.check-approval.outputs.is-approved == 'true'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Debug PR information
      run: |
        echo "PR Base Ref: ${{ github.event.pull_request.base.ref }}"
        echo "PR Head Ref: ${{ github.event.pull_request.head.ref }}"
        echo "PR Merged: ${{ github.event.pull_request.merged }}"
        echo "PR State: ${{ github.event.pull_request.state }}"
    
    - name: Create .env file and deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /opt/appointment-system
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          cat > .env << EOF
          DB_NAME=appointment_db
          DB_USER=appointment_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          PGADMIN_DEFAULT_EMAIL=admin@admin.com
          PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
          EOF
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É docker-compose (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º v1 –∏ v2)
          if command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then
            DOCKER_COMPOSE="docker compose"
          elif command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE="docker-compose"
          else
            echo "Installing docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            DOCKER_COMPOSE="docker-compose"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π commit –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
          echo "üìã Current commit before update:"
          git rev-parse HEAD || echo "Not a git repo or error"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ main (—Ç–∞–∫ –∫–∞–∫ PR —É–∂–µ –≤–ª–∏—Ç)
          echo "üì• Updating code from main branch..."
          git fetch origin
          git checkout main || git checkout -b main origin/main
          git reset --hard origin/main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π commit
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "‚úÖ Code updated to latest main branch"
          echo "üìã New commit hash: $NEW_COMMIT"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "üìù Recent commits:"
          git log --oneline -5
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
          echo "üõë Stopping containers..."
          $DOCKER_COMPOSE down || true
          
          # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ web (–±–µ–∑ –∫—ç—à–∞)
          echo "üî® Rebuilding Docker images (no cache)..."
          $DOCKER_COMPOSE build --no-cache web || echo "Warning: Build failed, continuing..."
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üöÄ Starting containers (force recreate)..."
          $DOCKER_COMPOSE up -d --force-recreate web || $DOCKER_COMPOSE up -d web
          
          # –ñ–¥–µ–º –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ Waiting for services to start..."
          sleep 20
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
          echo "üîç Checking container status..."
          $DOCKER_COMPOSE ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π –∫–æ–¥
          echo "üîç Verifying code in container..."
          CONTAINER_COMMIT=$($DOCKER_COMPOSE exec -T web git rev-parse HEAD 2>/dev/null || echo "Cannot check")
          echo "Container commit: $CONTAINER_COMMIT"
          echo "Expected commit: $NEW_COMMIT"
          
          if [ "$CONTAINER_COMMIT" = "$NEW_COMMIT" ]; then
            echo "‚úÖ Container is using correct commit!"
          else
            echo "‚ö†Ô∏è Warning: Container commit differs from expected"
          fi
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
          echo "üóÑÔ∏è Running migrations..."
          $DOCKER_COMPOSE exec -T web python manage.py migrate || echo "Migration failed"
          
          # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
          echo "üì¶ Collecting static files..."
          $DOCKER_COMPOSE exec -T web python manage.py collectstatic --noinput || echo "Collectstatic failed"
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä web –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
          echo "üîÑ Force restarting web container to load new code..."
          $DOCKER_COMPOSE stop web
          sleep 5
          $DOCKER_COMPOSE up -d web
          
          # –ñ–¥–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ Waiting for container restart..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
          echo "‚úÖ Final container status..."
          $DOCKER_COMPOSE ps
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
          echo "üìã Recent logs from web container..."
          $DOCKER_COMPOSE logs --tail=50 web
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç
          echo "üåê Checking web service health..."
          $DOCKER_COMPOSE exec -T web curl -f http://localhost:8000/ || echo "Health check failed"
          
          echo "Deployment completed!"
