name: Deploy to VPS

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ PR –∏–∑ develop –≤ main
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.pull_request.merged == true &&
        github.event.pull_request.base.ref == 'main' &&
        github.event.pull_request.head.ref == 'develop'
      )
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug PR information
      run: |
        echo "PR Base Ref: ${{ github.event.pull_request.base.ref }}"
        echo "PR Head Ref: ${{ github.event.pull_request.head.ref }}"
        echo "PR Merged: ${{ github.event.pull_request.merged }}"
        echo "PR State: ${{ github.event.pull_request.state }}"

    - name: Ensure app directory exists
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          if [ -z "$APP_DIR" ]; then
            echo "‚ùå Secret APP_DIR is required (example: /home/<user>/appointment-system)"
            exit 1
          fi
          mkdir -p "$APP_DIR"
          echo "APP_DIR=$APP_DIR"

    - name: Upload project files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: ${{ secrets.APP_DIR }}
    
    - name: Deploy (Python 3.10 + MySQL, no Docker)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          if [ -z "$APP_DIR" ]; then
            echo "‚ùå Secret APP_DIR is required (example: /home/<user>/appointment-system)"
            exit 1
          fi

          echo "üìÅ Using APP_DIR=$APP_DIR"
          cd "$APP_DIR"

          # –°–æ–∑–¥–∞–µ–º .env –∏–∑ Secrets (MySQL reg.ru)
          cat > .env << EOF
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          EOF

          # Python deps (prefer python3.10 on hosting)
          if command -v python3.10 >/dev/null 2>&1; then
            PYTHON_BIN="python3.10"
          elif command -v python3 >/dev/null 2>&1; then
            PYTHON_BIN="python3"
          else
            echo "‚ùå Python not found on server"
            exit 1
          fi

          echo "üêç Using $PYTHON_BIN"
          $PYTHON_BIN --version
          $PYTHON_BIN -m venv venv || true
          . venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

          # Django migrate + collectstatic
          cd appoinment_sistem
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ..

          # Restart gunicorn (simple, without systemd)
          PIDFILE="$APP_DIR/gunicorn.pid"
          LOGFILE="$APP_DIR/gunicorn.log"

          if [ -f "$PIDFILE" ]; then
            echo "üõë Stopping old gunicorn (pidfile)"
            kill -TERM "$(cat "$PIDFILE")" || true
            rm -f "$PIDFILE"
            sleep 2
          fi

          echo "üöÄ Starting gunicorn"
          nohup "$APP_DIR/venv/bin/gunicorn" appoinment_sistem.wsgi:application \
            --bind 127.0.0.1:8000 \
            --workers 2 \
            --pid "$PIDFILE" \
            > "$LOGFILE" 2>&1 &

          echo "‚úÖ Deploy completed. Logs: $LOGFILE"
