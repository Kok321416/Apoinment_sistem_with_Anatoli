name: Deploy to VPS

on:
  push:
    branches: [ main, master, develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create .env file and deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /opt/appointment-system
          
          # Создаем .env файл из секретов
          cat > .env << EOF
          DB_NAME=appointment_db
          DB_USER=appointment_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          PGADMIN_DEFAULT_EMAIL=admin@admin.com
          PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
          EOF
          
          # Обновляем код
          git pull origin develop || git pull origin main || git clone https://github.com/${{ github.repository }}.git .
          
          # Останавливаем старые контейнеры
          docker-compose down
          
          # Собираем и запускаем
          docker-compose build --no-cache
          docker-compose up -d
          
          # Ждем запуска БД
          sleep 10
          
          # Применяем миграции
          docker-compose exec -T web python manage.py migrate
          
          # Собираем статику
          docker-compose exec -T web python manage.py collectstatic --noinput
          
          echo "Deployment completed!"
