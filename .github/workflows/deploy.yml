name: Deploy to VPS

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ PR –∏–∑ develop –≤ main
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.pull_request.merged == true &&
        github.event.pull_request.base.ref == 'main' &&
        github.event.pull_request.head.ref == 'develop'
      )
    
    steps:
    - uses: actions/checkout@v4

    - name: Check required secrets
      run: |
        MISSING=""
        [ -z "${{ secrets.VPS_HOST }}" ] && MISSING="${MISSING}VPS_HOST "
        [ -z "${{ secrets.VPS_USER }}" ] && MISSING="${MISSING}VPS_USER "
        [ -z "${{ secrets.VPS_SSH_KEY }}" ] && MISSING="${MISSING}VPS_SSH_KEY "
        [ -z "${{ secrets.APP_DIR }}" ] && MISSING="${MISSING}APP_DIR "
        if [ -n "$MISSING" ]; then
          echo "::error::Missing GitHub Actions secrets: $MISSING"
          echo "Add them in: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "Required: VPS_HOST, VPS_USER, VPS_SSH_KEY, APP_DIR (and DB_*, SECRET_KEY, ALLOWED_HOSTS for deploy)"
          exit 1
        fi
        echo "Required deploy secrets are set."

    - name: Debug PR information
      run: |
        echo "PR Base Ref: ${{ github.event.pull_request.base.ref }}"
        echo "PR Head Ref: ${{ github.event.pull_request.head.ref }}"
        echo "PR Merged: ${{ github.event.pull_request.merged }}"
        echo "PR State: ${{ github.event.pull_request.state }}"

    - name: Ensure app directory exists
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          if [ -z "$APP_DIR" ]; then
            echo "‚ùå Secret APP_DIR is required (example: /home/<user>/appointment-system)"
            exit 1
          fi
          mkdir -p "$APP_DIR"
          echo "APP_DIR=$APP_DIR"

    - name: Upload project files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: ${{ secrets.APP_DIR }}
    
    - name: Deploy (Python 3.10 + MySQL, no Docker)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          if [ -z "$APP_DIR" ]; then
            echo "‚ùå Secret APP_DIR is required (example: /home/<user>/appointment-system)"
            exit 1
          fi

          echo "üìÅ Using APP_DIR=$APP_DIR"
          cd "$APP_DIR"

          # .env —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–∑ GitHub Secrets ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—Ä—É—á–Ω—É—é –Ω–µ –Ω—É–∂–Ω–æ
          cat > .env << EOF
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          SITE_URL=${{ secrets.SITE_URL }}
          GOOGLE_OAUTH_CLIENT_ID=${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_BOT_USERNAME=${{ secrets.TELEGRAM_BOT_USERNAME }}
          ADMIN_TELEGRAM_USERNAME=${{ secrets.ADMIN_TELEGRAM_USERNAME }}
          EOF

          # Ensure predictable PATH in non-interactive SSH
          export PATH="$HOME/.local/bin:$HOME/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

          # Python deps (prefer python3.10 on hosting)
          # You can override via Secrets:
          #   PYTHON_BIN=/full/path/to/python3.10
          PYTHON_BIN="${{ secrets.PYTHON_BIN }}"

          if [ -z "$PYTHON_BIN" ]; then
            # reg.ru often provides Python in /opt/python/*
            if [ -x "/opt/python/python-3.10.1/bin/python" ]; then
              PYTHON_BIN="/opt/python/python-3.10.1/bin/python"
            elif command -v python3.10 >/dev/null 2>&1; then
              PYTHON_BIN="python3.10"
            elif command -v python3 >/dev/null 2>&1; then
              PYTHON_BIN="python3"
            else
              echo "‚ùå Python not found on server"
              exit 1
            fi
          fi

          echo "üêç Using PYTHON_BIN=$PYTHON_BIN"
          command -v "$PYTHON_BIN" || true
          "$PYTHON_BIN" --version

          # Recreate venv to ensure correct Python version
          rm -rf venv
          "$PYTHON_BIN" -m venv venv
          . venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

          # Do NOT overwrite hosting .htaccess.
          # On reg.ru nginx-fronted hosting, an invalid .htaccess often causes 500.
          # If previous deploy created a broken .htaccess, move it aside and restore backup.
          if [ -f .htaccess ] && grep -q "PassengerEnabled" .htaccess; then
            mv .htaccess ".htaccess.broken.$(date +%s)" || true
          fi
          if [ ! -f .htaccess ] && [ -f .htaccess.bak ]; then
            cp .htaccess.bak .htaccess
          fi

          # –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (—Å–∫—Ä–∏–ø—Ç –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∏ –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ./scripts/migrate.sh)
          chmod +x scripts/migrate.sh
          ./scripts/migrate.sh

          # Passenger restart hook (safe even if Passenger is not used)
          mkdir -p tmp
          touch tmp/restart.txt
          # reg.ru (ispmanager) restart trigger for Django apps
          # File is removed automatically after restart
          touch .restart-app

          # Restart gunicorn (simple, without systemd)
          PIDFILE="$APP_DIR/gunicorn.pid"
          LOGFILE="$APP_DIR/gunicorn.log"
          DJANGO_DIR="appoinment_sistem"

          echo "üìå PWD: $(pwd)"
          if [ ! -d "$DJANGO_DIR" ]; then
            echo "‚ùå Django directory not found: $(pwd)/$DJANGO_DIR"
            echo "Contents of current directory:"
            ls -la
            exit 1
          fi

          if [ -f "$PIDFILE" ]; then
            echo "üõë Stopping old gunicorn (pidfile)"
            kill -TERM "$(cat "$PIDFILE")" || true
            rm -f "$PIDFILE"
            sleep 2
          fi

          echo "üöÄ Starting gunicorn"
          nohup "$APP_DIR/venv/bin/gunicorn" --chdir "$DJANGO_DIR" appoinment_sistem.wsgi:application \
            --bind 127.0.0.1:8000 \
            --workers 2 \
            --pid "$PIDFILE" \
            > "$LOGFILE" 2>&1 &

          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞ (—Ç–æ—Ç –∂–µ venv, –∫–æ—Ä–Ω–µ–≤–æ–π manage.py ‚Üí appoiment_system)
          BOT_PIDFILE="$APP_DIR/bot.pid"
          BOT_LOG="$APP_DIR/bot.log"
          if [ -f "$BOT_PIDFILE" ]; then
            OLD_PID=$(cat "$BOT_PIDFILE")
            kill -TERM "$OLD_PID" 2>/dev/null || true
            rm -f "$BOT_PIDFILE"
            sleep 2
          fi
          nohup python manage.py run_bot >> "$BOT_LOG" 2>&1 &
          BOT_PID=$!
          echo $BOT_PID > "$BOT_PIDFILE"
          sleep 2
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "‚úÖ Telegram bot restarted, PID $BOT_PID"
          else
            echo "‚ö†Ô∏è Bot may have exited. Check $BOT_LOG"
          fi

          echo "‚úÖ Deploy completed. Gunicorn: $LOGFILE, Bot: $BOT_LOG"
