name: Deploy to VPS

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  pull-requests: read
  contents: read

jobs:
  check-approval:
    runs-on: ubuntu-latest
    outputs:
      is-approved: ${{ steps.check.outputs.is-approved }}
      pr-number: ${{ github.event.pull_request.number }}
    
    steps:
      - name: Check PR approval
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseRef = context.payload.pull_request.base.ref;
            const headRef = context.payload.pull_request.head.ref;
            
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ PR Ğ¸Ğ· develop Ğ² main
            if (baseRef !== 'main' || headRef !== 'develop') {
              console.log(`Skipping: PR from ${headRef} to ${baseRef} (expected: develop -> main)`);
              core.setOutput('is-approved', 'false');
              return;
            }
            
            try {
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              
              // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ¸Ğ½ APPROVED review
              const hasApproval = reviews.some(review => review.state === 'APPROVED');
            
              console.log(`PR #${context.issue.number} from ${headRef} to ${baseRef}`);
              console.log(`Has approval: ${hasApproval}`);
              console.log(`Reviews: ${JSON.stringify(reviews.map(r => ({state: r.state, author: r.user.login})))}`);
              
              core.setOutput('is-approved', hasApproval.toString());
            } catch (error) {
              // Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº reviews, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ approval ĞµÑÑ‚ÑŒ (ĞµÑĞ»Ğ¸ PR merged, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ±Ñ‹Ğ» approved Ñ‡ĞµÑ€ĞµĞ· Branch Protection)
              console.log(`Cannot check reviews (may require Branch Protection): ${error.message}`);
              console.log(`PR merged status: ${context.payload.pull_request.merged}`);
              // Ğ•ÑĞ»Ğ¸ PR Ğ±Ñ‹Ğ» merged - ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ approval Ğ±Ñ‹Ğ» (Branch Protection Ğ½Ğµ Ğ´Ğ°ÑÑ‚ merge Ğ±ĞµĞ· approval)
              const hasApproval = context.payload.pull_request.merged === true;
              core.setOutput('is-approved', hasApproval.toString());
            }
    
  deploy:
    runs-on: ubuntu-latest
    needs: check-approval
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ ÑĞ»Ğ¸ÑĞ½Ğ¸Ğ¸ PR Ğ¸Ğ· develop Ğ² main Ñ approval
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'develop' &&
      needs.check-approval.outputs.is-approved == 'true'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Debug PR information
      run: |
        echo "PR Base Ref: ${{ github.event.pull_request.base.ref }}"
        echo "PR Head Ref: ${{ github.event.pull_request.head.ref }}"
        echo "PR Merged: ${{ github.event.pull_request.merged }}"
        echo "PR State: ${{ github.event.pull_request.state }}"
    
    - name: Create .env file and deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /opt/appointment-system
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
          cat > .env << EOF
          DB_NAME=appointment_db
          DB_USER=appointment_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          PGADMIN_DEFAULT_EMAIL=admin@admin.com
          PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
          EOF
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· main (Ñ‚Ğ°Ğº ĞºĞ°Ğº PR ÑƒĞ¶Ğµ Ğ²Ğ»Ğ¸Ñ‚)
          echo "ğŸ“¥ Updating code from main branch..."
          git fetch origin
          git checkout main
          git reset --hard origin/main
          echo "âœ… Code updated to latest main branch"
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ docker-compose (Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼ v1 Ğ¸ v2)
          if command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then
            DOCKER_COMPOSE="docker compose"
          elif command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE="docker-compose"
          else
            echo "Installing docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            DOCKER_COMPOSE="docker-compose"
          fi
          
          echo "ğŸ›‘ Stopping containers..."
          $DOCKER_COMPOSE down
          
          echo "ğŸ”¨ Rebuilding Docker images (no cache)..."
          $DOCKER_COMPOSE build --no-cache web
          
          echo "ğŸš€ Starting containers..."
          $DOCKER_COMPOSE up -d
          
          echo "â³ Waiting for services to start..."
          sleep 15
          
          echo "ğŸ—„ï¸ Running migrations..."
          $DOCKER_COMPOSE exec -T web python manage.py migrate
          
          echo "ğŸ“¦ Collecting static files..."
          $DOCKER_COMPOSE exec -T web python manage.py collectstatic --noinput
          
          echo "ğŸ”„ Restarting web container to load new code..."
          $DOCKER_COMPOSE restart web
          
          echo "âœ… Checking container status..."
          $DOCKER_COMPOSE ps
          
          echo "ğŸ“‹ Recent logs..."
          $DOCKER_COMPOSE logs --tail=30 web
          
          echo "Deployment completed!"
