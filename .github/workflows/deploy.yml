name: Deploy to VPS

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  pull-requests: read
  contents: read

jobs:
  check-approval:
    runs-on: ubuntu-latest
    outputs:
      is-approved: ${{ steps.check.outputs.is-approved }}
      pr-number: ${{ github.event.pull_request.number }}
    
    steps:
      - name: Check PR approval
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseRef = context.payload.pull_request.base.ref;
            const headRef = context.payload.pull_request.head.ref;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ PR –∏–∑ develop –≤ main
            if (baseRef !== 'main' || headRef !== 'develop') {
              console.log(`Skipping: PR from ${headRef} to ${baseRef} (expected: develop -> main)`);
              core.setOutput('is-approved', 'false');
              return;
            }
            
            try {
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω APPROVED review
              const hasApproval = reviews.some(review => review.state === 'APPROVED');
            
              console.log(`PR #${context.issue.number} from ${headRef} to ${baseRef}`);
              console.log(`Has approval: ${hasApproval}`);
              console.log(`Reviews: ${JSON.stringify(reviews.map(r => ({state: r.state, author: r.user.login})))}`);
              
              core.setOutput('is-approved', hasApproval.toString());
            } catch (error) {
              // –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ reviews, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ approval –µ—Å—Ç—å (–µ—Å–ª–∏ PR merged, –∑–Ω–∞—á–∏—Ç –±—ã–ª approved —á–µ—Ä–µ–∑ Branch Protection)
              console.log(`Cannot check reviews (may require Branch Protection): ${error.message}`);
              console.log(`PR merged status: ${context.payload.pull_request.merged}`);
              // –ï—Å–ª–∏ PR –±—ã–ª merged - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ approval –±—ã–ª (Branch Protection –Ω–µ –¥–∞—Å—Ç merge –±–µ–∑ approval)
              const hasApproval = context.payload.pull_request.merged === true;
              core.setOutput('is-approved', hasApproval.toString());
            }
    
  deploy:
    runs-on: ubuntu-latest
    needs: check-approval
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ PR –∏–∑ develop –≤ main —Å approval
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'develop' &&
      needs.check-approval.outputs.is-approved == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug PR information
      run: |
        echo "PR Base Ref: ${{ github.event.pull_request.base.ref }}"
        echo "PR Head Ref: ${{ github.event.pull_request.head.ref }}"
        echo "PR Merged: ${{ github.event.pull_request.merged }}"
        echo "PR State: ${{ github.event.pull_request.state }}"

    - name: Ensure app directory exists
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          if [ -z "$APP_DIR" ]; then
            echo "‚ùå Secret APP_DIR is required (example: /home/<user>/appointment-system)"
            exit 1
          fi
          mkdir -p "$APP_DIR"
          echo "APP_DIR=$APP_DIR"

    - name: Upload project files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: ${{ secrets.APP_DIR }}
    
    - name: Deploy (Python 3.10 + MySQL, no Docker)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR="${{ secrets.APP_DIR }}"
          if [ -z "$APP_DIR" ]; then
            echo "‚ùå Secret APP_DIR is required (example: /home/<user>/appointment-system)"
            exit 1
          fi

          echo "üìÅ Using APP_DIR=$APP_DIR"
          cd "$APP_DIR"

          # –°–æ–∑–¥–∞–µ–º .env –∏–∑ Secrets (MySQL reg.ru)
          cat > .env << EOF
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          EOF

          # Python deps (Python 3.10)
          python3 --version
          python3 -m venv venv || true
          . venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

          # Django migrate + collectstatic
          cd appoinment_sistem
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          cd ..

          # Restart gunicorn (simple, without systemd)
          PIDFILE="$APP_DIR/gunicorn.pid"
          LOGFILE="$APP_DIR/gunicorn.log"

          if [ -f "$PIDFILE" ]; then
            echo "üõë Stopping old gunicorn (pidfile)"
            kill -TERM "$(cat "$PIDFILE")" || true
            rm -f "$PIDFILE"
            sleep 2
          fi

          echo "üöÄ Starting gunicorn"
          nohup "$APP_DIR/venv/bin/gunicorn" appoinment_sistem.wsgi:application \
            --bind 127.0.0.1:8000 \
            --workers 2 \
            --pid "$PIDFILE" \
            > "$LOGFILE" 2>&1 &

          echo "‚úÖ Deploy completed. Logs: $LOGFILE"
