{% extends 'bookings/base.html' %}

{% block title %}{{ calendar.name }} - Система записи на консультации{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>{{ calendar.name }}</h1>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'calendar_edit' calendar_id=calendar.id %}" class="btn btn-secondary">Настройки календаря</a>
            <a href="{% url 'specialist_calendars' %}" class="btn btn-secondary">Назад</a>
        </div>
    </div>
    
    {% if calendar.description %}
        <p style="color: #6b21a8; margin-bottom: 20px;">{{ calendar.description }}</p>
    {% endif %}

    <div class="calendar-settings-bar">
        <span class="setting-pill"><strong>Перерыв:</strong> {{ calendar.break_between_services_minutes|default:0 }} мин</span>
        <span class="setting-pill"><strong>Лимит в день:</strong> {% if calendar.max_services_per_day %}{{ calendar.max_services_per_day }}{% else %}—{% endif %}</span>
        <span class="setting-pill"><strong>Запись за:</strong> {{ calendar.book_ahead_hours|default:24 }} ч</span>
        <a href="{% url 'calendar_edit' calendar_id=calendar.id %}" class="setting-edit">Изменить</a>
    </div>
    
    <div style="margin-bottom: 30px;">
        <button type="button" class="btn" onclick="addNewDay()" style="margin-bottom: 20px;">+ Добавить день</button>
        <div id="days-container">
            {% if slots_by_date %}
                {% for date_key, slots in slots_by_date.items %}
                    <div class="day-card" data-date="{{ date_key|date:'Y-m-d' }}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0; color: #6b21a8;">{{ date_key|date:"d.m.Y" }}</h2>
                            <button type="button" class="btn" onclick="addSlotToExistingDay(this)" style="font-size: 20px; padding: 5px 15px;">+</button>
                        </div>
                        
                        <div class="existing-slots" style="margin-bottom: 15px;">
                            {% for slot in slots %}
                                <div class="existing-slot">
                                    <span class="slot-time-range">{{ slot.start_time|time:"H:i" }} – {{ slot.end_time|time:"H:i" }}</span>
                                    {% if slot.service %}<span class="slot-service-name">{{ slot.service.name }}</span>{% endif %}
                                    <span class="badge {% if slot.is_booked %}danger{% else %}success{% endif %}">{% if slot.is_booked %}Занят{% else %}Свободен{% endif %}</span>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="new-slots-container" style="display: none;">
                            <!-- Новые слоты будут добавляться сюда -->
                        </div>
                        
                        <form method="post" class="day-form" style="display: none;" onsubmit="event.preventDefault(); submitSlotsSequentially(this, this.querySelector('.slots-container'), this.querySelector('input[name=\"date\"]'), this.closest('.day-card'));">
                            {% csrf_token %}
                            <input type="hidden" name="date" value="{{ date_key|date:'Y-m-d' }}">
                            <div class="slots-container"></div>
                            <button type="submit" class="btn" style="margin-top: 10px;">Сохранить слоты</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelNewSlots(this)" style="margin-top: 10px; margin-left: 10px;">Отмена</button>
                        </form>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<script>
let slotCounter = 0;

function addNewDay() {
    const container = document.getElementById('days-container');
    const dayCard = document.createElement('div');
    dayCard.className = 'day-card';
    dayCard.style.marginBottom = '20px';
    dayCard.style.padding = '20px';
    dayCard.style.border = '1px solid #e9e5ff';
    dayCard.style.borderRadius = '16px';
    dayCard.style.background = '#faf5ff';
    dayCard.style.boxShadow = '0 2px 8px rgba(139, 92, 246, 0.06)';
    
    const dateInput = document.createElement('input');
    dateInput.type = 'date';
    dateInput.required = true;
    dateInput.style.marginBottom = '15px';
    dateInput.style.padding = '10px';
    dateInput.style.width = '100%';
    dateInput.style.border = '1px solid #e5e7eb';
    dateInput.style.borderRadius = '12px';
    
    const slotsContainer = document.createElement('div');
    slotsContainer.className = 'slots-container';
    slotsContainer.style.marginTop = '15px';
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.className = 'day-form';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
    }
    
    const dateField = document.createElement('input');
    dateField.type = 'hidden';
    dateField.name = 'date';
    dateField.value = '';
    dateInput.addEventListener('change', function() {
        dateField.value = this.value;
    });
    form.appendChild(dateField);
    
    const addSlotBtn = document.createElement('button');
    addSlotBtn.type = 'button';
    addSlotBtn.className = 'btn';
    addSlotBtn.textContent = '+ Добавить слот';
    addSlotBtn.style.marginTop = '10px';
    addSlotBtn.onclick = function() { addSlotForm(slotsContainer, dateInput); };
    
    const saveBtn = document.createElement('button');
    saveBtn.type = 'submit';
    saveBtn.className = 'btn';
    saveBtn.textContent = 'Сохранить слоты';
    saveBtn.style.marginTop = '10px';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.type = 'button';
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.textContent = 'Отмена';
    cancelBtn.style.marginTop = '10px';
    cancelBtn.style.marginLeft = '10px';
    cancelBtn.onclick = function() { dayCard.remove(); };
    
    // Обработчик отправки формы - отправляем слоты по одному
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitSlotsSequentially(form, slotsContainer, dateInput, dayCard);
    });
    
    const label = document.createElement('label');
    label.textContent = 'Выберите дату:';
    label.style.display = 'block';
    label.style.marginBottom = '10px';
    label.style.fontWeight = 'bold';
    
    dayCard.appendChild(label);
    dayCard.appendChild(dateInput);
    dayCard.appendChild(form);
    form.appendChild(slotsContainer);
    dayCard.appendChild(addSlotBtn);
    dayCard.appendChild(saveBtn);
    dayCard.appendChild(cancelBtn);
    
    container.appendChild(dayCard);
    
    // Автоматически добавляем первый слот
    addSlotForm(slotsContainer, dateInput);
}

function addSlotToExistingDay(button) {
    const dayCard = button.closest('.day-card');
    const form = dayCard.querySelector('.day-form');
    const dateInput = form.querySelector('input[name="date"]');
    const slotsContainer = form.querySelector('.slots-container');
    
    // Показываем форму
    form.style.display = 'block';
    
    // Добавляем обработчик submit, если его еще нет
    if (!form.hasAttribute('data-submit-handler')) {
        form.setAttribute('data-submit-handler', 'true');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            submitSlotsSequentially(form, slotsContainer, dateInput, dayCard);
        });
    }
    
    // Добавляем слот
    addSlotForm(slotsContainer, dateInput);
}

function cancelNewSlots(button) {
    const dayCard = button.closest('.day-card');
    const form = dayCard.querySelector('.day-form');
    const slotsContainer = form.querySelector('.slots-container');
    
    // Очищаем контейнер слотов
    slotsContainer.innerHTML = '';
    form.style.display = 'none';
}

function submitSlotsSequentially(form, slotsContainer, dateInput, dayCard) {
    const slots = slotsContainer.querySelectorAll('.slot-form');
    // Получаем значение даты (может быть из input или hidden field)
    let dateValue = '';
    if (dateInput) {
        if (dateInput.type === 'date') {
            dateValue = dateInput.value;
        } else {
            dateValue = dateInput.value || dateInput.getAttribute('value');
        }
    } else {
        // Если dateInput не передан, пытаемся найти в форме
        const dateField = form.querySelector('input[name="date"]');
        if (dateField) {
            dateValue = dateField.value || dateField.getAttribute('value');
        }
    }
    
    if (!dateValue) {
        alert('Пожалуйста, выберите дату');
        return;
    }
    
    if (slots.length === 0) {
        alert('Пожалуйста, добавьте хотя бы один слот');
        return;
    }
    
    // Проверяем все слоты перед отправкой
    let hasErrors = false;
    slots.forEach(slotForm => {
        const startTime = slotForm.querySelector('.slot-start-time').value;
        const endTime = slotForm.querySelector('.slot-end-time').value;
        
        if (!startTime || !endTime) {
            hasErrors = true;
        } else if (startTime >= endTime) {
            alert('Время окончания должно быть позже времени начала');
            hasErrors = true;
        }
    });
    
    if (hasErrors) {
        return;
    }
    
    // Отправляем слоты последовательно
    let index = 0;
    function submitNext() {
        if (index >= slots.length) {
            // Все слоты отправлены, перезагружаем страницу
            window.location.reload();
            return;
        }
        
        const slotForm = slots[index];
        const startTime = slotForm.querySelector('.slot-start-time').value;
        const endTime = slotForm.querySelector('.slot-end-time').value;
        const service = slotForm.querySelector('.slot-service').value;
        
        const submitForm = document.createElement('form');
        submitForm.method = 'POST';
        submitForm.style.display = 'none';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            submitForm.appendChild(csrfInput);
        }
        
        const dateField = document.createElement('input');
        dateField.type = 'hidden';
        dateField.name = 'date';
        dateField.value = dateValue;
        submitForm.appendChild(dateField);
        
        const startField = document.createElement('input');
        startField.type = 'hidden';
        startField.name = 'start_time';
        startField.value = startTime;
        submitForm.appendChild(startField);
        
        const endField = document.createElement('input');
        endField.type = 'hidden';
        endField.name = 'end_time';
        endField.value = endTime;
        submitForm.appendChild(endField);
        
        if (service) {
            const serviceField = document.createElement('input');
            serviceField.type = 'hidden';
            serviceField.name = 'service';
            serviceField.value = service;
            submitForm.appendChild(serviceField);
        }
        
        document.body.appendChild(submitForm);
        submitForm.submit();
        
        index++;
        if (index < slots.length) {
            setTimeout(submitNext, 200);
        }
    }
    
    submitNext();
}

function addSlotForm(container, dateInput) {
    const slotForm = document.createElement('div');
    slotForm.className = 'slot-form';
    slotForm.style.marginTop = '15px';
    slotForm.style.padding = '15px';
    slotForm.style.background = 'white';
    slotForm.style.borderRadius = '5px';
    slotForm.style.border = '1px solid #e5e7eb';
    
    const slotId = 'slot_' + slotCounter++;
    
    // Получаем значение даты (может быть из input или hidden field)
    const dateValue = dateInput ? (dateInput.value || dateInput.getAttribute('value')) : '';
    
    slotForm.innerHTML = `
        <div class="slot-form-grid">
            <div class="slot-field">
                <label>Начало</label>
                <input type="time" name="start_time" required class="slot-start-time">
            </div>
            <div class="slot-field">
                <label>Конец</label>
                <input type="time" name="end_time" required class="slot-end-time">
            </div>
            <div class="slot-field">
                <label>Услуга</label>
                <select name="service" class="slot-service">
                    <option value="">—</option>
                    {% for service in services %}
                    <option value="{{ service.id }}">{{ service.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" class="btn-slot-remove" onclick="this.closest('.slot-form').remove()" title="Удалить">×</button>
        </div>
    `;
    
    container.appendChild(slotForm);
}
</script>

<style>
.calendar-settings-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    padding: 14px 18px;
    background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    border-radius: 16px;
    border: 1px solid #e9e5ff;
}
.setting-pill {
    padding: 6px 12px;
    background: white;
    border-radius: 999px;
    font-size: 13px;
    color: #5b21b6;
    box-shadow: 0 1px 3px rgba(139, 92, 246, 0.1);
}
.setting-edit {
    margin-left: auto;
    font-size: 13px;
    color: #8b5cf6;
    text-decoration: none;
}
.setting-edit:hover { text-decoration: underline; }

.day-card {
    margin-bottom: 20px;
    padding: 20px;
    border: 1px solid #e9e5ff;
    border-radius: 16px;
    background: #faf5ff;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.06);
}

.slot-form {
    margin-top: 12px;
    padding: 14px;
    background: white;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

.slot-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1.2fr auto;
    gap: 12px;
    align-items: end;
}
.slot-field { display: flex; flex-direction: column; gap: 4px; }
.slot-field label {
    font-size: 12px;
    color: #6b7280;
    font-weight: 500;
}
.slot-field input,
.slot-field select {
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    font-size: 14px;
}
.btn-slot-remove {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #6b7280;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    flex-shrink: 0;
}
.btn-slot-remove:hover { background: #fee2e2; color: #dc2626; }

.slots-container { margin-top: 12px; }

.existing-slot {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    margin: 4px;
    background: white;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    font-size: 13px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.slot-time-range { font-weight: 600; color: #374151; }
.slot-service-name { color: #6b7280; font-size: 12px; }

.existing-slots {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
</style>
{% endblock %}
