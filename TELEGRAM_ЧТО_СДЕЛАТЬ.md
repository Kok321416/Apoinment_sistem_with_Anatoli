# Что сделать, чтобы заработал функционал с Telegram-ботом

## 1. Создать бота в Telegram

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram.
2. Отправьте `/newbot`, придумайте имя и username бота (например: `MyBookingBot`).
3. Сохраните **токен** (вид: `123456789:AAH...`) и **username** (без `@`, например: `MyBookingBot`).

---

## 2. Переменные окружения

В `.env` в **корне проекта** (рядом с `manage.py`) должны быть:

| Переменная | Описание | Пример |
|------------|----------|--------|
| `TELEGRAM_BOT_TOKEN` | Токен от BotFather | `123456789:AAH...` |
| `TELEGRAM_BOT_USERNAME` | Username бота **без @** | `MyBookingBot` |
| `SITE_URL` | Публичный URL сайта (где открывается запись и consultant_menu) | `https://ваш-домен.ru` |

- **Важно:** `SITE_URL` — это тот же домен, на котором работает сайт с формой записи (страница «Запись создана» и API подтверждения). Бот будет слать запросы на `SITE_URL/api/booking/confirm-telegram/`.
- Если деплоите через GitHub Actions — добавьте эти переменные в **Secrets** репозитория (уже учтены в `deploy.yml` и `deploy-bot.yml`).

---

## 3. Миграции

Чтобы у записей (Booking) были поля `link_token` и `telegram_id`:

**Локально:**

```bash
# из корня проекта
cd appoinment_sistem
python manage.py migrate

# миграции для бота (корневой проект)
cd ..
python manage.py migrate
```

**На сервере** при деплое обычно вызывается `./scripts/migrate.sh` — он мигрирует оба проекта.

---

## 4. Запуск бота

Бот получает обновления по **long polling** (по умолчанию), вебхук настраивать не обязательно.

**Локально** (из корня проекта, где лежит `manage.py`):

```bash
python manage.py run_bot
```

Оставьте процесс запущенным в отдельном терминале или в фоне.

**На сервере** при деплое бот перезапускается автоматически (в `deploy.yml` и `deploy-bot.yml`). Вручную:

```bash
cd /путь/к/проекту
source venv/bin/activate
nohup python manage.py run_bot >> bot.log 2>&1 &
```

Проверка: в Telegram откройте бота и отправьте `/start` — должен прийти ответ.

---

## 5. Проверка цепочки «подтверждение в Telegram»

1. На сайте создайте запись (форма записи на консультацию).
2. На странице «Запись создана» должна появиться кнопка **«Открыть Telegram и подтвердить»** (если заданы `TELEGRAM_BOT_USERNAME` и у записи есть `link_token`).
3. Нажмите кнопку — откроется бот с сообщением и кнопкой «✅ Подтвердить и получать уведомления».
4. Нажмите кнопку в боте — бот отправит запрос на ваш сайт `SITE_URL/api/booking/confirm-telegram/`. В ответ должно прийти «Готово! Уведомления будут приходить сюда.»

Если кнопка на странице успеха не появляется — проверьте, что в настройках **appoinment_sistem** подставляется `TELEGRAM_BOT_USERNAME` (он читается из того же `.env` в корне, если appoinment_sistem загружает `BASE_DIR.parent / ".env"`).

---

## 5.1. Напоминания клиенту о консультации

После того как клиент подтвердил привязку в боте, ему можно автоматически отправлять напоминания за **24 часа** и за **1 час** до консультации. Это делает команда из приложения с записями (appoinment_sistem), используя тот же `TELEGRAM_BOT_TOKEN`.

**Запуск вручную** (из каталога `appoinment_sistem`):

```bash
cd appoinment_sistem
python manage.py send_booking_reminders
```

**По расписанию (cron)** — чтобы напоминания уходили сами, добавьте задачу, например каждые 30 минут:

```bash
*/30 * * * * cd /путь/к/проекту/appoinment_sistem && /путь/к/venv/bin/python manage.py send_booking_reminders >> /путь/к/логам/reminders.log 2>&1
```

Команда находит записи с заполненным `telegram_id` и статусом «Ожидает»/«Подтверждена», и отправляет в Telegram сообщение за 24 ч и за 1 ч до начала. Убедитесь, что в `.env` задан `TELEGRAM_BOT_TOKEN` (он уже нужен для бота и для входа через Telegram).

---

## 6. Два проекта в репозитории (кратко)

- **appoinment_sistem** — основной сайт (gunicorn): форма записи, страница «Запись создана», API ` /api/booking/confirm-telegram/`. Для кнопки «В Telegram» нужен `TELEGRAM_BOT_USERNAME` в его настройках (из `.env`).
- **appoiment_system** (корневой `manage.py`) — здесь живут `bookings` и `telegram_bot`. Команда `python manage.py run_bot` использует настройки этого проекта; `SITE_URL` из его `.env` нужен боту, чтобы вызывать API подтверждения на вашем сайте.

На сервере обычно один домен: nginx/прокси отдаёт запросы в gunicorn (appoinment_sistem). В `.env` в корне задаёте один и тот же `SITE_URL` (ваш домен) — и сайт, и бот будут обращаться по одному адресу.

---

## Итоговый чек-лист

- [ ] Бот создан в @BotFather, токен и username сохранены.
- [ ] В `.env`: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_BOT_USERNAME`, `SITE_URL`.
- [ ] Миграции применены (для appoinment_sistem и при необходимости для appoiment_system).
- [ ] Бот запущен: `python manage.py run_bot` (локально или на сервере).
- [ ] В Telegram по `/start` бот отвечает.
- [ ] После создания записи на сайте видна кнопка «Открыть Telegram и подтвердить», по нажатию открывается бот и кнопка «Подтвердить» привязывает запись к Telegram.
- [ ] (Опционально) Напоминания клиенту: настроен cron для `python manage.py send_booking_reminders` из каталога `appoinment_sistem` (каждые 15–30 мин).

После этого весь функционал с Telegram-ботом (подтверждение записи и напоминания по привязанному `telegram_id`) будет работать.
