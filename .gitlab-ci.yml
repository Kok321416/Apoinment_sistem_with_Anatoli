# GitLab CI/CD конфигурация для автоматического деплоя Telegram бота
# Используйте этот файл, если используете GitLab CI/CD

stages:
  - deploy

deploy_bot:
  stage: deploy
  script:
    - echo "Деплой Telegram бота на сервер..."
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << EOF
        cd $DEPLOY_PATH
        git pull origin main
        source venv/bin/activate
        pip install -r requirements.txt
        python manage.py migrate
        python manage.py collectstatic --noinput
        # Обновляем переменные окружения в systemd service
        sudo systemctl set-environment TELEGRAM_BOT_TOKEN="$TELEGRAM_BOT_TOKEN"
        # SITE_URL опционально, обновляем только если указан
        if [ ! -z "$SITE_URL" ]; then
          sudo systemctl set-environment SITE_URL="$SITE_URL"
        fi
        sudo systemctl daemon-reload
        sudo systemctl restart telegram-bot
        sudo systemctl status telegram-bot
      EOF
  variables:
    TELEGRAM_BOT_TOKEN: $TELEGRAM_BOT_TOKEN
    # SITE_URL опционально, можно не указывать
  only:
    - main
  when: manual

